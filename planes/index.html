<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
		<script src="js/knockout.2.0.0.js"></script> 
		<script src="js/sammy.js"></script> 
		
		<link rel="stylesheet" type="text/css" href="css/main.css" />
		<link rel="stylesheet" type="text/css" href="css/nav.css"/> 
	</head>
<body>
	<!--<hr>
	<h2>debug</h2>
	MenuItem: <span data-bind="text:selectedMenuItem"></span> 
	<br>
	MenuData: <span data-bind="text:ko.toJSON(selectedMenuData)"></span>
	<br>
	columns: <span data-bind="text:ko.toJSON(templateColumns)"></span>
	<hr>-->

	<!-- Menu -->
	<div id="menuContainer">

	</div>
	
	
	<!-- function here to lookup data for boilerplate messaging: getScreenData(...) = {header:'blah', footer:'blah'}--> 
	
	<!-- world data view table --> 
	<div id="worldViewContainer">
		<!--<ul><li data-bind="text:ko.toJSON(timer)"></li><li><a href="#" data-bind="click:toggleTimer">Start/Stop</a></li></ul>-->
		<ul class="headerMenuBar">
			<li class="button"><a href="#" data-bind="click:toggleTimer, css: {on: timer().running }">Start/Stop</a></li>
			Running: <li class="infoBox" data-bind="text:timer().running"></li>
		</ul>
		<!--<ul class="menu" data-bind="foreach: menuItems">
			<li data-bind="text: $data,
                   css: { selected: $data == $root.selectedMenuItem() },
                   click: $root.goToScreen"></li>
		</ul>--> <!--removing for now til i need sammy again--> 
		
		
		<table>
			<thead><tr data-bind="template:{name:'tableHeader', foreach:templateColumns}"></tr></thead>
			<tbody data-bind="template:{name:'tableBody', foreach:selectedMenuData}"</tbody> 
		</table>
		
		<script id="tableHeader" type="text/html">
			<td><span data-bind="text:$data"></span></td>
		</script>
		
		<script id="tableBody" type="text/html">
			<tr data-bind="foreach: $parent.templateColumns"><td><span data-bind="text:$parent[$data]"></span></td></tr>				
		</script>
	</div>
	
	<div id="statusContainer"></div> 
	<script type="text/javascript">	
	function gameTimer() { 
		var self = this; 
		//Game runner
		self.running = ko.observable(false); 
		self.startTime = ko.observable(null); 
		self.lastStartStop = ko.observable(null); 
		
		self.timerId = null; 
		self.startTimer = function() { 
			var instance = this; //for scoping the this - otherwise, it's the DOMWindow (window.setInterval)
			if (!self.timerId) { 
				this.timerId = setInterval(function() { 
					self.run();
				},1000);
			
			} 
		} ;
		
		self.stopTimer = function() { 
			clearInterval(self.timerId); 
			self.timerId = null; 
		} 
		
		self.run = function() { 
			if (self.running())
			{
				$("#statusContainer").append("."); 
				for (var key in self.objectsToUpdate) //maybe just hold the id's of the objects? 
				{
					var obj = self.objectsToUpdate[key];
					$.each(obj, function(index, value) { 
						//console.log(value.name());
						value.update(); 
					} ); 
					//for (var prop in obj)
					//{
					//	console.log(key, prop); 
					//}
				}
			}
		} 
		
		self.toggle = function() { 
			self.running(!self.running()); 
		
			if (self.startTime() == null) 
				self.startTime(new Date()); 
			
			self.lastStartStop(new Date()); 
			
		};
		
		//each object should be an array, objects in the array have to define an update method  TODO: make sure this is just a reference
		self.objectsToUpdate = {  }; 
	}; 
	
	
	function WorldViewModel () {
		var self = this; 
		//Game runner
		self.timer = ko.observable(new gameTimer()) ; 
		self.toggleTimer = function() { self.timer().toggle(); } 
		
		//Data
		self.menuItems = ['Home','Planes','Airports','Passengers', 'Companies'];
		self.selectedMenuItem = ko.observable("Home"); 
		self.selectedMenuData = ko.observableArray(); 
		
	
		self.templateColumns = ko.computed(function() { 
			//get the first item in the array, build a list of its object properties to serve as columns //TODO: a way to cache this, maybe an array of [menuItem (key), cachedData (value)]
			if ((self.selectedMenuData() != null) && (self.selectedMenuData()[0] != undefined)) 
			{
				var obj = self.selectedMenuData()[0]; 
				var props = []; 
				for (var prop in obj) {
					props.push(prop); 
				}
				return props; 
			}
			return [];
						
		}, self); 
		
		//template switching
		//self.templateToUse = function() {return self.selectedMenuItem()}.bind(self); 
		
		//Behaviors
		self.goToScreen = function (menuItem) { location.hash = menuItem; }; 

		// Client-side routes
		Sammy(function (context) {
			this.get('#:menuItem', function () {
				var selectedItem = this.params.menuItem; 
				self.selectedMenuData(null);

				if (selectedItem === 'Home')  //more for things that aren't loading data? 
				{
					self.selectedMenuItem(selectedItem); 
					self.selectedMenuData([{"info": "Home Data here"}]); 
					return false;
				}
					
				//only do this for things i know how to handle
				//if (!(self.menuItems.contains(this.params.menuItem)))
				//{
				//	return false; 
				//} 
				
				//get file name
				var dataFile = selectedItem.toLowerCase() + '.json';  
				console.log(dataFile); 
				//todo - cache these
				$.ajax({
          				url: 'data/' + dataFile,
          				dataType: 'json',
          				success: function(items) {
							//alert ("updating menu item to " + selectedItem); 
							self.selectedMenuItem(selectedItem);
							
							//alert ("updating menu data") ; 
							//set the view & data //todo - switch view when caching. error handle. 
							self.selectedMenuData(items); 
         			 }
        		});
				//$.get("/mail", { folder: this.params.folder }, self.selectedFolderData);
			});
			
			this.get('#:menuItem/:itemId', function () {
				self.selectedMenuItem(this.params.menuItem);
				self.selectedMenuData(null);
				//$.get("/mail", { mailId: this.params.mailId }, self.selectedMailData);
			});
			
			//home screen
			//this.get('', function () { this.app.runRoute('get', '#Inbox') });
			
		}).run(); 
		
	}
	var wvmodel = new WorldViewModel;
	ko.applyBindings(wvmodel, document.getElementById("worldViewContainer")); 
 
	//doing this breaks the prototypes since they're looking at 'this', which is the domWindow from window.setInterval
	//var gameStep = window.setInterval(wvmodel.timer().run, 1000) ; 
	
	
	//string.format equiv
	String.format = String.prototype.format = function() {
    var i=0;
    var string = (typeof(this) == "function" && !(i++)) ? arguments[0] : this;
 
    for (; i < arguments.length; i++)
        string = string.replace(/\{\d+?\}/, arguments[i]);
 
    return string;
}
	Array.prototype.contains = function (itemId){
	for (index in this) {  //todo check speed
		if (this[index].name === itemId)
		{
			return true; 
		}
	}
	return false; 
	};
	</script> 	
	
	<!-- **** AirportS **** --> 
	<!-- Airports view --> 
	<div id="AirportsViewContainer">
		<h2>Airports(<span data-bind="text: Airports().length"></span>)</h2>
		<table border=1 data-bind="visible: Airports().length > 0">
			<thead><tr>
				<th>Airport Name</th><th>Gates</th><th>Passengers Waiting</th><th>Location</th><th>Planes at Airport</th><th>Closed?</th><th>Controls</th>
			</tr></thead>
			<tbody data-bind="foreach: Airports">
				<tr>
					<td><span data-bind="text: name" /></td>
					<td><span data-bind="text: gates" /></td>
					<td data-bind="text: passengersWaiting"></td>
					<td data-bind="text: location"></td>
					<td data-bind="text: PlanesAtAirport().length"</td>
					<td data-bind="text: closed"></td>
					<td><a href="#" data-bind="click: $root.openOrClose">Close/Open</a> | 
					<a href="#" data-bind="click: $root.removeAirport">Remove</a></td>
				</tr>    
			</tbody>
		</table>
		Enter a New Plane
		<form data-bind="submit:addAirport">
			<table>
				<td><input data-bind="value: newName" placeholder="Airport Name" /></td>
				<td><input data-bind="value: newGates" placeholder="Airport Gates" /></td><!--select-->
				<td><input data-bind="value: newpassengerGainRate" placeholder="Passengers Gained/sec" /></td><!--select/consPlane-->
				<!--<td><select data-bind="options: $root.availableMeals, value: meal, optionsText: 'mealName'"></select></td>-->
				<td><input data-bind="value: newXLoc" placeholder="X location"/></td><!--validate-->
				<td><input data-bind="value: newYLoc" placeholder="Y location"/></td><!--validate-->
				<!-- enable = funds for this Plane < my funds   enable: Planes().length < 5--> 
			</table>
			<button type="submit">Add Airport</button>
		</form>
		<button data-bind="click: saveAirports(), enable: Airports().length > 0">Save To Local Storage</button>
		
	</div>
	
	
	<!-- Airports objects & viemodel --> 
	<script type="text/javascript">
	function Airport(name, gates, xLoc, yLoc, passengerGainRate)
	{
		var self=this; 
		self.name = ko.observable(name); 
		self.gates = ko.observable(gates); 
		self.passengerGainRate = ko.observable(passengerGainRate); 
		self.xLoc = xLoc; 
		self.yLoc = yLoc;
		self.passengersWaiting = ko.observable(60); 
		self.closed = ko.observable(false); 
		self.PassengersReady = false; // use to ask for a Plane pickup
		 
		
		self.location = ko.computed(function() { 
			return self.xLoc + ',' + self.yLoc; 
		}); 
		
		self.gatesAvailable = ko.computed(function() {
			var PlanesOnHand = 0; //go get this
			return self.gates > self.PlanesOnHand; 
		});
		
		self.gainPassengers = function() { 
			if (!self.closed())
			{
			//increment Passengers
				self.passengersWaiting(self.passengersWaiting() + self.passengerGainRate()) ;  
			}
		} 
		self.update = function() { 
			self.gainPassengers(); 
		};
		
		self.PlanesAtAirport = ko.computed(function() { 
			return PlanesModel.getPlanesAtAirport(self.name()); 
		} );
		
		//semi-override
		self.getDistanceToAirportName = function(destinationAirportName) {
			var destAirport = AirportsModel.getAirport(destinationAirportName); 
			return self.getDistanceToAirport(destAirport); 
		}
		
		self.getDistanceToAirport = function(destinationAirport) { 
			var xDist = (destinationAirport.xLoc - self.xLoc); 
			var yDist = (destinationAirport.yLoc - self.yLoc); 
			var distance = Math.sqrt(xDist*xDist + yDist*yDist); 
			return distance; 
		}; 
		
		//in case this needs to do more than toggle one day?
		self.toggleState = function () 	{ self.closed(!self.closed()) }
	
	};
	
	function AirportsViewModel() {
		var self = this; 
		self.Airports = ko.observableArray(); 
		self.AirportsLimit = 10; 
		//fields for adding
		self.newName = ko.observable(); 
		self.newGates = ko.observable(); 
		self.newXLoc = ko.observable(); 
		self.newYLoc = ko.observable(); 
		self.newpassengerGainRate = ko.observable(); 
		
		//save to local storage
		self.saveAirports = function () { 
			localStorage.setItem('Airports', JSON.stringify(self.Airports)); 
		} ;
		//get from local storage
		self.loadPlanes = function() {
			var retrievedObject = localStorage.getItem('Airports');
			self.Airports = JSON.parse(retrievedObject);
		}; 
		
		self.addAirport = function() {
		//check for existing, autogen id? 
			self.Airports.push(new Airport(self.newName(), self.newGates(), self.newXLoc(), self.newYLoc(), self.newpassengerGainRate())); 
		};
		
		self.openOrClose = function(thisAirport) { 
			thisAirport.toggleState(); 
		} 
		
		self.removeAirport = function(thisAirport) { 	
			self.Airports.remove(thisAirport); 
		};
		
		self.addAirportsAllowed = ko.computed(function() { 
			return self.Airports().length < self.AirportsLimit; 
		});
		
		self.getAirport = function(AirportName) { 
			return ko.utils.arrayFirst(self.Airports(), function(Airport) {
				return Airport.name() === AirportName; 
			}); 				
		}; 
		
		self.findNearestAirport = function() { }; //todo
		
		//random finder - replace this later
		self.findRandomDestinationAirport = function(AirportName) { 
			var otherAirports = ko.utils.arrayFilter(self.Airports(), function(Airport) {
				return Airport.name() != AirportName; 
			});
			var randNum=Math.floor(Math.random() * otherAirports.length)
			return otherAirports[randNum]; 
		};
	};
	var AirportsModel = new AirportsViewModel; 
	ko.applyBindings(AirportsModel, document.getElementById("AirportsViewContainer")); 
	
	</script> 
	<!-- **** PlaneS **** --> 
	<!-- Planes view --> 
	<div id="PlanesViewContainer">
		<h2>Your Planes (<span data-bind="text: Planes().length"></span>)</h2>
		<table border=1 data-bind="visible: Planes().length > 0">
			<thead><tr>
				<th>Plane name</th><th>Model</th><th>Capacity</th><th>Passenger Space</th><th>Current Airport</th><th>Destination</th><th>Controls</th>
			</tr></thead>
			<tbody data-bind="foreach: Planes">
				<tr>
					<td><span data-bind="text: name" /></td>
					<td><span data-bind="text: model" /></td>
					<!--<td><select data-bind="options: $root.availableMeals, value: meal, optionsText: 'mealName'"></select></td>-->
					<td data-bind="text: capacity"></td> 
					<td data-bind="text: freeCapacity"></td> 
					<td data-bind="if:currentAirport()"><span data-bind="text:currentAirport().name"></span></td> 
					<td data-bind="if:destinationAirport()"><span data-bind="text:destinationAirport().name"></span></td> 
					<td><a href="#" data-bind="click: $root.removePlane">Retire</a></td>
				</tr>    
			</tbody>
		</table>
		Enter a New Plane
		<form data-bind="submit:addPlane">
			<table>
				<td><input data-bind="value: newName" placeholder="Plane Name" /></td>
				<td><input data-bind="value: newModel" placeholder="Plane Model" /></td><!--select-->
				<!--<td><select data-bind="options: $root.availableMeals, value: meal, optionsText: 'mealName'"></select></td>-->
				<td><input data-bind="value: newStartAirport" placeholder="Start Airport"/></td><!--select-->
				<!-- enable = funds for this Plane < my funds   enable: Planes().length < 5--> 
			</table>
			<button type="submit">Buy Plane</button>
		</form>
		<button data-bind="click: savePlanes(), enable: Planes().length > 0">Save To Local Storage</button>
		
	</div>
	<!-- Planes objects & viewmodel --> 
	<script type="text/javascript">
	function Plane(name, model, purchaseDate, startAirport)
	{
		var self=this; 
		self.name = ko.observable(name); 
		self.model = ko.observable(model); 
		self.speed = 20; //todo: base on model
		self.purchaseDate = purchaseDate; 
		self.startAirport = startAirport; 
		self.currentAirport = ko.observable(startAirport);
		self.destinationAirport = ko.observable(null); 
		self.currentXLoc = self.currentAirport().xLoc; 
		self.currentYLoc = self.currentAirport().yLoc; 
		self.lastRepairDate = 6;
		self.tuneUpOrdered = false; 
		self.capacity = 15; 
		self.passengersOnBoard = ko.observable(5); 
		self.travelPoints = []; 
		
		self.condition = ko.computed(function() { 
			var repairDuration = 10 - self.lastRepairDate; //0 needs to be world calendar date
			//get model's reliability
			var reliability = 80; 
			return repairDuration * self.lastRepairDate; 
		}); 
		
		self.freeCapacity = ko.computed(function() { 
			return self.capacity - self.passengersOnBoard(); 
		}); 
		
		self.update = function() { 
			//move
			//TODO: rework this, pub-sub? 
			if (self.passengersOnBoard() > 0) 
			{
				//null to start? 
				if (!self.destinationAirport()) 
					//self.destinationAirport(AirportsModel.findNearestAirportNeedingPassengers(self.currentAirport())); 
					self.destinationAirport(AirportsModel.findRandomDestinationAirport(self.currentAirport().name())); 
				//if we have't reached it yet, keep going
				if (self.destinationAirport() && self.currentAirport().name() != self.destinationAirport().name()) 
				{
					//travel to destination
					if (self.travelPoints.length == 0)
					{
						self.travelPoints = bline(self.currentXLoc, self.currentYLoc, self.destinationAirport().xLoc, self.destinationAirport().yLoc); 
					}
					else
					{
						//get the next two points from the start of the array
						var nextX = self.travelPoints.shift(); 
						var nextY = self.travelPoints.shift(); 
						//put the plane there
						self.currentXLoc = nextX; 
						self.currentYLoc = nextY; 
						console.log(self.name() + "[" + self.currentXLoc + "," + self.currentYLoc + "]"); 
						if (self.currentXLoc === self.destinationAirport().xLoc && self.currentYLoc === self.destinationAirport().yLoc)
							self.currentAirport(self.destinationAirport()); //todo: take time based on speed
					}
					
				}
				else //we're at the destination
				{
					//release them all? once they can connect, add some to the station) 
					//self.currentAirport().passengersWaiting(self.currentAirport().passengersWaiting() + self.passengersOnBoard()); //todo: take into account Airport capacity
					self.passengersOnBoard(0); 
					self.destinationAirport(null); //todo: pick up Passengers to trigger move
				}
			}
			else //nobody on board, start loading
			{
				var airportPassengers = self.currentAirport().passengersWaiting(); 
				if (airportPassengers > 0)
				{
					if (airportPassengers >= self.capacity) 
					{
						self.passengersOnBoard(self.capacity);
						self.currentAirport().passengersWaiting(airportPassengers - self.capacity); 
					}
					else
					{
						self.passengersOnBoard(airportPassengers); 
						self.currentAirport().passengersWaiting(0); 
					}
				}
			}
			//if (AirportsModel.getAirport(self.startAirport)
			//pickup/move Passengers
			
		}
	
	};
	
	function PlanesViewModel() {
		var self = this; 
		self.Planes = ko.observableArray(); 
		self.PlanesLimit = 10; 
		//fields for adding
		self.newName =ko.observable(); 
		self.newModel = ko.observable(); 
		self.newStartAirport = ko.observable(); 
		
		
		//save to local storage
		self.savePlanes = function () { 
			localStorage.setItem('Planes', JSON.stringify(self.Planes)); 
		} ;
		//get from local storage
		self.loadPlanes = function() {
			var retrievedObject = localStorage.getItem('Planes');
			self.Planes = JSON.parse(retrievedObject);
		}; 
		
		self.addPlane = function() {
		//check for existing, autogen id? 
			self.Planes.push(new Plane(self.newName(), self.newModel(), "9/9/9", self.newStartAirport())); 
		};
		
		self.removePlane = function(thisPlane) { 	
			self.Planes.remove(thisPlane); 
		};
		
		self.addPlanesAllowed = ko.computed(function() { 
			return self.Planes().length < self.PlanesLimit; 
		});
		
		self.getPlane = function(PlaneName) { 
			return ko.utils.arrayFirst(self.Planes(), function(Plane) {
				return Plane.name() === PlaneName; 
			}); 				
		}; 
		
		self.getPlanesAtAirport = function(AirportName) { 
			return ko.utils.arrayFilter(self.Planes(), function(Plane) {
				return Plane.currentAirport() === AirportName; 
			}); 				
		}; 
	};
	var PlanesModel = new PlanesViewModel; 
	ko.applyBindings(PlanesModel, document.getElementById("PlanesViewContainer")); 
	
	//bresenham's line algorithm
	function bline(x0, y0, x1, y1) {
	  var points = []; 
	  var dx = Math.abs(x1 - x0), sx = x0 < x1 ? 1 : -1;
	  var dy = Math.abs(y1 - y0), sy = y0 < y1 ? 1 : -1; 
	  var err = (dx>dy ? dx : -dy)/2;
	 
	  while (true) {
		//setPixel(x0,y0);
		$("#statusContainer").append(x0 + ',' + y0+'|') ; 
		points.push(x0); 
		points.push(y0); 
		if (x0 === x1 && y0 === y1) break;
		var e2 = err;
		if (e2 > -dx) { err -= dy; x0 += sx; }
		if (e2 < dy) { err += dx; y0 += sy; }
	  }
	  return points; 
	}
	</script> 

	<script type="text/javascript"> 
		//what are we watching? 

		AirportsModel.Airports.push(new Airport("San Francisco","2",10,50,0)); 
		AirportsModel.Airports.push(new Airport("New Orleans","2",20,70,0));
		PlanesModel.Planes.push(new Plane("PlaneOne","ModelABC", "12/21/2000", AirportsModel.getAirport("San Francisco"))); 
		PlanesModel.Planes.push(new Plane("PlaneTwo","ModelDDD", "12/21/2004", AirportsModel.getAirport("New Orleans"))); 
		
		wvmodel.timer().objectsToUpdate = {"Airports": AirportsModel.Airports(), "Planes" : PlanesModel.Planes()}; 
		//start me up
		wvmodel.timer().startTimer();
		
	</script>
</body>
</html>